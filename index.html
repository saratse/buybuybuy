<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ® æ—¥æœ¬ä»£è³¼æ¸…å–® - Vibe è³¼ç‰©åˆ—è¡¨</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* 1. Core Variables & Font Styling (æ—¥å¼ç°¡ç´„æ·±è‰²ä¸»é¡Œ) */
        :root {
            /* ä¸»é¡Œè‰² */
            --color-primary-bg: #1A1A2E; /* æ·±æµ·è—/è¿‘é»‘ */
            --color-card-bg: #2A2A4A;    /* è¼ƒæ·ºå¡ç‰‡èƒŒæ™¯ */
            --color-text-light: #E0E0E0; /* æ·ºè‰²ä¸»æ–‡å­— */
            --color-accent: #FF9A70;     /* æš–æ©˜è‰²/æ—¥å¼æš–è‰² */
            --color-success: #38A169;    /* ç¶ è‰² (å·²è³¼è²·) */
            /* å­—é«”ï¼šä½¿ç”¨æ€æºé»‘é«” (Noto Sans TC) æˆ–ç³»çµ±é è¨­çš„ç„¡è¥¯ç·šä¸­æ–‡å­—é«” */
            --font-family: 'Noto Sans TC', 'Hiragino Sans', 'å¾®è»Ÿæ­£é»‘é«”', 'Microsoft JhengHei', sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--color-primary-bg);
            color: var(--color-text-light);
            min-height: 100vh;
        }

        /* 2. Custom Utility Classes */
        .card-bg { background-color: var(--color-card-bg); }
        .accent-bg { background-color: var(--color-accent); }
        .accent-text { color: var(--color-accent); }
        .success-border { border-left-color: var(--color-success); }
        .success-text { color: var(--color-success); }

        /* 3. Purchased Item Style */
        .item-purchased {
            opacity: 0.6;
            border-left: 5px solid var(--color-success);
            background-color: #232338; /* ç¨å¾®è®Šæš— */
        }
        .item-purchased .item-name {
            /* text-decoration: line-through; ç”¨æˆ¶åé¥‹åç¨±å¤ªé•·ï¼ŒåŠƒæ‰æœƒçœ‹ä¸æ¸…ï¼Œæ”¹ç‚ºè®Šç° */
            color: #888888; 
        }

        /* 4. Ensure inputs contrast well */
        input:focus, select:focus, textarea:focus {
            outline: none !important;
            border-color: var(--color-accent) !important;
            box-shadow: 0 0 0 2px rgba(255, 154, 112, 0.5) !important;
        }

        /* 5. Mobile Layout adjustment */
        .main-container {
            max-width: 100%; /* Full width on mobile */
            padding: 1rem;
        }

        @media (min-width: 640px) {
            .main-container {
                max-width: 480px; /* Constrain width on larger screens */
            }
        }
        
        /* 6. Fullscreen Modal Style */
        .fullscreen-modal {
            transition: opacity 0.3s ease-in-out;
            pointer-events: none; /* é è¨­ä¸æ“‹æ»‘é¼ äº‹ä»¶ */
            opacity: 0;
        }
        .fullscreen-modal.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* 7. Total Display Style */
        .total-box {
            background-color: #3a4759; /* è¼ƒæ·ºçš„æ·±è‰² */
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
        
        /* 8. Filter Select Styling */
        .filter-select {
            background-color: #2A2A4A;
            color: #E0E0E0;
            border: 1px solid #4B5563;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            appearance: none;
        }
    </style>
</head>
<body class="antialiased">

    <div class="main-container mx-auto">

        <!-- æ¨™é¡Œå€ -->
        <header class="text-center py-6 border-b border-gray-700 mb-4">
            <h1 class="text-4xl font-extrabold accent-text">æ—…æ—¥ä»£è³¼æ¸…å–®</h1>
            <p class="text-sm text-gray-400 mt-1">Friends' Vibe List Â· ä»£è³¼ç®¡ç†èˆ‡çµç®—</p>
        </header>
        
        <!-- ç¸½é‡‘é¡é¡¯ç¤ºå€ (å·¦å³åˆ†æ¬„ï¼šé ç®— vs æ”¯å‡º) -->
        <div class="total-box grid grid-cols-2 gap-4 divide-x divide-gray-600">
            <!-- å·¦å´ï¼šå¾…è³¼é ç®— -->
            <div>
                <p class="text-xs text-gray-400 mb-1">å¾…è³¼é ç®— (JPY)</p>
                <p id="pendingTotalJPY" class="text-2xl font-bold text-white">0</p>
                <p class="text-xs text-gray-500 mt-1">HKD: <span id="pendingTotalHKD">0.00</span></p>
            </div>
            <!-- å³å´ï¼šå¯¦éš›æ”¯å‡º -->
            <div>
                <p class="text-xs text-gray-400 mb-1">å¯¦éš›æ”¯å‡º (JPY)</p>
                <p id="spentTotalJPY" class="text-2xl font-bold text-accent-text">0</p>
                <p class="text-xs text-gray-500 mt-1">HKD: <span id="spentTotalHKD">0.00</span></p>
            </div>
        </div>

        <!-- ç¯©é¸å€å¡Š (æ–°å¢) -->
        <section class="mb-6 grid grid-cols-2 gap-3">
            <div>
                <select id="filterFriend" class="filter-select w-full p-2 rounded-lg text-sm">
                    <option value="all">æ‰€æœ‰äºº</option>
                    <!-- å‹•æ…‹ç”Ÿæˆé¸é … -->
                </select>
            </div>
            <div>
                <select id="filterCategory" class="filter-select w-full p-2 rounded-lg text-sm">
                    <option value="all">æ‰€æœ‰é¡å‹</option>
                    <!-- å‹•æ…‹ç”Ÿæˆé¸é … -->
                </select>
            </div>
        </section>

        <!-- åŒ¯å…¥èˆ‡ç®¡ç†å€å¡Š -->
        <section class="mb-8 p-4 rounded-xl card-bg shadow-xl">
            <div class="flex flex-col space-y-3">
                <div class="grid grid-cols-2 gap-3">
                     <!-- æ–°å¢é …ç›®æŒ‰éˆ• -->
                    <button id="addItemBtn" class="bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition duration-200 shadow-md text-sm">
                        <i class="fas fa-plus-circle mr-1"></i> æ‰‹å‹•æ–°å¢
                    </button>
                    <!-- åŒ¯å‡ºå ±å‘ŠæŒ‰éˆ• (æ–°å¢) -->
                    <button id="exportBtn" class="bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition duration-200 shadow-md text-sm">
                        <i class="fas fa-file-export mr-1"></i> åŒ¯å‡ºçµç®—
                    </button>
                </div>

                <!-- CSV åŒ¯å…¥æŒ‰éˆ• -->
                <label for="csvFile" class="flex-grow text-center py-3 rounded-lg font-bold cursor-pointer accent-bg text-color-primary-bg hover:opacity-90 transition duration-200 shadow-md text-sm">
                    <i class="fas fa-file-upload mr-2"></i> åŒ¯å…¥ Google è¡¨å–® CSV
                </label>
                <input type="file" id="csvFile" accept=".csv" class="hidden">
                
                <!-- æ¸…é™¤è³‡æ–™æŒ‰éˆ• -->
                <button id="clearDataBtn" class="bg-red-900/50 text-red-300 py-2 rounded-lg text-xs hover:bg-red-900 transition duration-200">
                    <i class="fas fa-trash-alt mr-1"></i> æ¸…é™¤æ‰€æœ‰è¨˜éŒ„
                </button>
            </div>
        </section>

        <!-- æ¸…å–®é¡¯ç¤ºå€ -->
        <section class="mb-20">
            <h2 class="text-xl font-semibold mb-4 flex justify-between items-center">
                æ¸…å–®åˆ—è¡¨
                <span class="text-sm text-gray-400">é¡¯ç¤º: <span id="visibleCount" class="font-bold text-white">0</span> / <span id="totalCount">0</span></span>
            </h2>
            <div id="itemList" class="space-y-4">
                <!-- ä»£è³¼é …ç›®å°‡ç”± JavaScript æ¸²æŸ“åˆ°é€™è£¡ -->
                <p id="emptyListMessage" class="text-center text-gray-500 italic p-6 rounded-lg card-bg hidden">
                    <i class="fas fa-box-open mr-2"></i> ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é …ç›®ã€‚
                </p>
            </div>
        </section>

    </div>

    <!-- ç·¨è¼¯ Modal -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50 transition-opacity duration-300 hidden">
        <div class="card-bg w-full max-w-md rounded-2xl p-6 shadow-2xl transform scale-100 transition-transform duration-300 max-h-[90vh] overflow-y-auto">
            <h3 id="modalTitle" class="text-2xl font-bold mb-5 accent-text border-b border-gray-700 pb-2">ç·¨è¼¯é …ç›®è©³æƒ…</h3>
            <form id="editForm" class="space-y-4">
                
                <!-- åŸºç¤è³‡è¨Š -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label for="editName" class="block text-xs font-medium text-gray-400 mb-1">è³¼è²·ç‰©åç¨± <span class="text-red-400">*</span></label>
                        <input type="text" id="editName" required class="w-full p-3 rounded-xl bg-gray-700 border border-gray-600 focus:border-accent-bg">
                    </div>
                    <!-- æ–°å¢å‚™è¨»æ¬„ä½ -->
                    <div class="col-span-2">
                        <label for="editRemark" class="block text-xs font-medium text-gray-400 mb-1">å‚™è¨» (Remark) - é¿å…åç¨±éé•·</label>
                        <textarea id="editRemark" rows="2" class="w-full p-3 rounded-xl bg-gray-700 border border-gray-600 focus:border-accent-bg" placeholder="ä¾‹å¦‚ï¼šè¦ç´…è‰²æ¬¾ï¼Œä¸è¦åŒ…è£..."></textarea>
                    </div>
                    <div>
                        <label for="editFriend" class="block text-xs font-medium text-gray-400 mb-1">å¡«å¯«äºº <span class="text-red-400">*</span></label>
                        <input type="text" id="editFriend" required class="w-full p-3 rounded-xl bg-gray-700 border border-gray-600 focus:border-accent-bg">
                    </div>
                    <div>
                        <label for="editCategory" class="block text-xs font-medium text-gray-400 mb-1">é¡å‹</label>
                        <input type="text" id="editCategory" class="w-full p-3 rounded-xl bg-gray-700 border border-gray-600 focus:border-accent-bg">
                    </div>
                </div>

                <!-- é è¨ˆè³‡è¨Š -->
                <div class="p-3 bg-gray-800/50 rounded-xl border border-gray-700">
                    <p class="text-xs text-gray-500 mb-2 font-bold">é è¨ˆ / ç›®æ¨™</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="editQuantity" class="block text-xs font-medium text-gray-400 mb-1">é è¨ˆæ•¸é‡ <span class="text-red-400">*</span></label>
                            <input type="number" id="editQuantity" required min="1" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-accent-bg">
                        </div>
                        <div>
                            <label for="editEstimatedPrice" class="block text-xs font-medium text-gray-400 mb-1">é è¨ˆå–®åƒ¹ (JPY)</label>
                            <input type="text" id="editEstimatedPrice" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-accent-bg" inputmode="numeric">
                        </div>
                    </div>
                </div>

                <!-- å¯¦éš›è³¼è²·è³‡è¨Š (æ–°å¢) -->
                <div class="p-3 bg-green-900/20 rounded-xl border border-green-900/50">
                    <p class="text-xs text-green-500 mb-2 font-bold"><i class="fas fa-calculator mr-1"></i> å¯¦éš›çµç®— (é¸å¡«)</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="editActualQuantity" class="block text-xs font-medium text-gray-400 mb-1">å¯¦éš›è³¼è²·é‡</label>
                            <input type="number" id="editActualQuantity" min="0" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-accent-bg" placeholder="å¦‚ç¼ºè²¨å¡« 0">
                        </div>
                        <div>
                            <label for="editActualPrice" class="block text-xs font-medium text-gray-400 mb-1">å¯¦éš›å–®åƒ¹ (JPY)</label>
                            <input type="text" id="editActualPrice" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-accent-bg" inputmode="numeric" placeholder="ç•™ç©ºå‰‡ç”¨é è¨ˆ">
                        </div>
                    </div>
                </div>

                <!-- é€£çµ -->
                <div>
                    <label for="editReferenceLink" class="block text-xs font-medium text-gray-400 mb-1">åƒè€ƒé€£çµ</label>
                    <input type="url" id="editReferenceLink" class="w-full p-3 rounded-xl bg-gray-700 border border-gray-600 focus:border-accent-bg">
                </div>

                <!-- åœ–ç‰‡ä¸Šå‚³ -->
                <div class="border-t border-gray-700 pt-4">
                    <label class="block text-xs font-medium text-gray-400 mb-2">åœ–ç‰‡è¨˜éŒ„</label>
                    <div class="flex items-center space-x-3">
                        <label for="imageUpload" class="px-4 py-2 text-xs bg-gray-600 rounded-lg cursor-pointer hover:bg-gray-500 transition duration-200">
                            <i class="fas fa-camera mr-1"></i> æ‹ç…§/ä¸Šå‚³
                        </label>
                        <input type="file" id="imageUpload" accept="image/*" class="hidden">
                        
                        <button type="button" id="removeImageBtn" class="px-4 py-2 text-xs bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-200 hidden">
                            ç§»é™¤
                        </button>
                    </div>
                    <div id="imagePreviewContainer" class="mt-3 hidden">
                        <img id="imageThumbnail" class="w-20 h-20 object-cover rounded-lg border-2 border-accent-bg cursor-pointer hover:opacity-80" alt="Thumbnail">
                    </div>
                </div>

                <!-- ç‹€æ…‹ -->
                <div class="flex items-center pt-2 border-t border-gray-700">
                    <input type="checkbox" id="editPurchased" class="h-5 w-5 text-accent-bg rounded border-gray-500 focus:ring-accent-bg bg-gray-700">
                    <label for="editPurchased" class="ml-3 block text-base font-medium text-gray-300">å·²å®Œæˆè³¼è²·</label>
                </div>
                
                <!-- æ“ä½œæŒ‰éˆ• -->
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="closeModalBtn" class="px-5 py-2 text-gray-300 rounded-xl hover:bg-gray-700 transition duration-200">å–æ¶ˆ</button>
                    <button type="submit" class="px-5 py-2 accent-bg text-color-primary-bg rounded-xl font-semibold hover:opacity-90 transition duration-200 shadow-lg">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- è¨Šæ¯æç¤º -->
    <div id="messageBox" class="fixed top-5 right-5 z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="bg-gray-800 text-white px-4 py-3 rounded-lg shadow-xl flex items-center">
            <i id="messageIcon" class="mr-2"></i>
            <span id="messageText"></span>
        </div>
    </div>

    <!-- ç¢ºèª Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50 hidden">
        <div class="card-bg w-full max-w-sm rounded-2xl p-6 shadow-2xl">
            <h3 id="confirmTitle" class="text-xl font-bold mb-4 text-red-400"></h3>
            <p id="confirmMessage" class="mb-6 text-gray-300"></p>
            <div class="flex justify-end space-x-3">
                <button id="confirmCancelBtn" class="px-4 py-2 text-gray-300 rounded-lg hover:bg-gray-700 transition duration-200">å–æ¶ˆ</button>
                <button id="confirmConfirmBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition duration-200">ç¢ºå®š</button>
            </div>
        </div>
    </div>
    
    <!-- å…¨å±åœ–ç‰‡ Modal -->
    <div id="fullImageModal" class="fixed inset-0 bg-black bg-opacity-95 flex flex-col items-center justify-center p-4 z-[100] fullscreen-modal" onclick="closeFullImageModal()">
        <button onclick="closeFullImageModal(event)" class="absolute top-4 right-4 text-white text-3xl z-[110] hover:text-gray-300 transition">
            <i class="fas fa-times"></i>
        </button>
        <img id="fullImageDisplay" src="" alt="Full Image" class="max-w-full max-h-full object-contain cursor-pointer" onclick="event.stopPropagation()">
        <p id="fullImageHint" class="absolute bottom-4 text-sm text-gray-400">é»æ“Šä»»æ„è™•é—œé–‰</p>
    </div>

    <!-- JavaScript é‚è¼¯ -->
    <script>
        const THUMB_MAX_SIZE = 120;
        const FULL_IMAGE_MAX_SIZE = 800; // ç¨å¾®åŠ å¤§å…¨å±åœ–å°ºå¯¸
        const THUMB_QUALITY = 0.6;
        const FULL_IMAGE_QUALITY = 0.8;
        const HKD_RATE = 0.06;

        function resizeImageAndConvertToBase64(file, maxSize, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxSize || height > maxSize) {
                             if (width > height) {
                                height *= maxSize / width; width = maxSize;
                            } else {
                                width *= maxSize / height; height = maxSize;
                            }
                        }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = '#1A1A2E'; ctx.fillRect(0, 0, width, height);
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = () => reject('Image load error');
                    img.src = event.target.result;
                };
                reader.onerror = () => reject('File read error');
                reader.readAsDataURL(file);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Elements
            const itemList = document.getElementById('itemList');
            const csvFile = document.getElementById('csvFile');
            const clearDataBtn = document.getElementById('clearDataBtn');
            const addItemBtn = document.getElementById('addItemBtn');
            const exportBtn = document.getElementById('exportBtn'); // New
            
            // Filters
            const filterFriend = document.getElementById('filterFriend'); // New
            const filterCategory = document.getElementById('filterCategory'); // New
            const visibleCountSpan = document.getElementById('visibleCount');
            const totalCountSpan = document.getElementById('totalCount');

            // Modals & Forms
            const editModal = document.getElementById('editModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const editForm = document.getElementById('editForm');
            const emptyListMessage = document.getElementById('emptyListMessage');
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            const messageIcon = document.getElementById('messageIcon');
            const modalTitle = document.getElementById('modalTitle');
            
            // Totals
            const pendingTotalJPY = document.getElementById('pendingTotalJPY');
            const pendingTotalHKD = document.getElementById('pendingTotalHKD');
            const spentTotalJPY = document.getElementById('spentTotalJPY');
            const spentTotalHKD = document.getElementById('spentTotalHKD');

            // Confirm Modal
            const confirmModal = document.getElementById('confirmModal');
            const confirmTitle = document.getElementById('confirmTitle');
            const confirmMessage = document.getElementById('confirmMessage');
            const confirmConfirmBtn = document.getElementById('confirmConfirmBtn');
            const confirmCancelBtn = document.getElementById('confirmCancelBtn');
            
            // Full Image
            const fullImageModal = document.getElementById('fullImageModal');
            const fullImageDisplay = document.getElementById('fullImageDisplay');

            // Image Edit
            const imageUpload = document.getElementById('imageUpload');
            const removeImageBtn = document.getElementById('removeImageBtn');
            const imageThumbnail = document.getElementById('imageThumbnail');
            const imagePreviewContainer = document.getElementById('imagePreviewContainer');
            
            let items = loadItems();
            let currentEditIndex = null;
            let confirmResolver = null;

            // --- Full Image Modal Functions ---
            window.openFullImageModal = (base64Url, event) => {
                if(event) event.stopPropagation();
                fullImageDisplay.src = base64Url;
                fullImageModal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            window.closeFullImageModal = (event) => {
                if(event) event.stopPropagation();
                fullImageModal.classList.remove('active');
                document.body.style.overflow = '';
            }

            imageThumbnail.addEventListener('click', (event) => {
                const fullBase64 = imageThumbnail.dataset.fullBase64;
                if (fullBase64) openFullImageModal(fullBase64, event);
            });

            // --- Utility Functions ---
            function showMessage(text, type = 'success') {
                messageText.textContent = text;
                messageBox.className = 'fixed top-5 right-5 z-50 transition-opacity duration-300 opacity-0 pointer-events-none';
                if (type === 'success') {
                    messageIcon.className = 'fas fa-check-circle text-green-400';
                    messageBox.classList.add('bg-green-700/90');
                } else if (type === 'error') {
                    messageIcon.className = 'fas fa-exclamation-triangle text-red-400';
                    messageBox.classList.add('bg-red-700/90');
                } else {
                    messageIcon.className = 'fas fa-info-circle text-blue-400';
                    messageBox.classList.add('bg-gray-800/90');
                }
                setTimeout(() => { messageBox.classList.remove('opacity-0'); messageBox.classList.add('opacity-100'); }, 10);
                setTimeout(() => { messageBox.classList.remove('opacity-100'); messageBox.classList.add('opacity-0'); }, 3000);
            }
            
            function showConfirm(title, message, confirmText = 'ç¢ºå®š', confirmColor = 'bg-red-600') {
                return new Promise(resolve => {
                    confirmTitle.textContent = title;
                    confirmMessage.textContent = message;
                    confirmConfirmBtn.textContent = confirmText;
                    confirmConfirmBtn.className = `px-4 py-2 ${confirmColor} text-white rounded-lg font-semibold hover:opacity-80 transition duration-200`;
                    confirmModal.classList.remove('hidden');
                    confirmResolver = resolve;
                });
            }

            confirmConfirmBtn.addEventListener('click', () => {
                confirmModal.classList.add('hidden');
                if (confirmResolver) { confirmResolver(true); confirmResolver = null; }
            });

            confirmCancelBtn.addEventListener('click', () => {
                confirmModal.classList.add('hidden');
                if (confirmResolver) { confirmResolver(false); confirmResolver = null; }
            });
            
            // --- Totals Calculation (Updated) ---
            function calculateAndDisplayTotals() {
                let pTotal = 0; // Pending (Estimated)
                let sTotal = 0; // Spent (Actual)

                items.forEach(item => {
                    const estimatedPrice = parseFloat(item.estimatedPrice) || 0;
                    const estimatedQty = parseInt(item.quantity) || 0;
                    
                    // Actual logic: if actual price is missing, use estimated. If actual qty is missing, use estimated qty (IF purchased).
                    // Logic requirement: "Actual purchase amount". Usually implies purchased items.
                    const actualPrice = (item.actualPrice !== undefined && item.actualPrice !== "" && item.actualPrice !== null) ? parseFloat(item.actualPrice) : estimatedPrice;
                    const actualQty = (item.actualQuantity !== undefined && item.actualQuantity !== "" && item.actualQuantity !== null) ? parseInt(item.actualQuantity) : estimatedQty;

                    if (!item.purchased) {
                        pTotal += estimatedPrice * estimatedQty;
                    } else {
                        // For purchased items, count towards spent total
                        sTotal += actualPrice * actualQty;
                    }
                });
                
                // Display Pending
                pendingTotalJPY.textContent = pTotal.toLocaleString('en-US', { maximumFractionDigits: 0 });
                pendingTotalHKD.textContent = (pTotal * HKD_RATE).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                
                // Display Spent
                spentTotalJPY.textContent = sTotal.toLocaleString('en-US', { maximumFractionDigits: 0 });
                spentTotalHKD.textContent = (sTotal * HKD_RATE).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                
                totalCountSpan.textContent = items.length;
            }

            // --- Filter Logic (New) ---
            function updateFilterOptions() {
                // Get unique Friends and Categories
                const friends = [...new Set(items.map(i => i.friend))].sort();
                const categories = [...new Set(items.map(i => i.category || 'å…¶ä»–'))].sort();

                // Save current selection to restore if possible
                const currentFriend = filterFriend.value;
                const currentCategory = filterCategory.value;

                // Populate Friend Filter
                filterFriend.innerHTML = '<option value="all">æ‰€æœ‰äºº</option>';
                friends.forEach(f => {
                    const option = document.createElement('option');
                    option.value = f;
                    option.textContent = f;
                    filterFriend.appendChild(option);
                });
                if (friends.includes(currentFriend)) filterFriend.value = currentFriend;

                // Populate Category Filter
                filterCategory.innerHTML = '<option value="all">æ‰€æœ‰é¡å‹</option>';
                categories.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c;
                    option.textContent = c;
                    filterCategory.appendChild(option);
                });
                if (categories.includes(currentCategory)) filterCategory.value = currentCategory;
            }

            function filterItems() {
                const selectedFriend = filterFriend.value;
                const selectedCategory = filterCategory.value;
                
                const itemDivs = document.querySelectorAll('.item-card');
                let visible = 0;

                itemDivs.forEach(div => {
                    const index = div.dataset.index;
                    const item = items[index];
                    
                    const matchFriend = selectedFriend === 'all' || item.friend === selectedFriend;
                    const matchCategory = selectedCategory === 'all' || (item.category || 'å…¶ä»–') === selectedCategory;

                    if (matchFriend && matchCategory) {
                        div.classList.remove('hidden');
                        visible++;
                    } else {
                        div.classList.add('hidden');
                    }
                });
                
                visibleCountSpan.textContent = visible;
                
                if (visible === 0 && items.length > 0) {
                    emptyListMessage.classList.remove('hidden');
                    emptyListMessage.textContent = "æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„é …ç›®";
                } else if (items.length === 0) {
                    emptyListMessage.classList.remove('hidden');
                    emptyListMessage.textContent = "ç›®å‰æ²’æœ‰ä»£è³¼é …ç›®ã€‚è«‹åŒ¯å…¥ CSV æˆ–æ‰‹å‹•æ–°å¢ã€‚";
                } else {
                    emptyListMessage.classList.add('hidden');
                }
            }

            // --- Data Persistence ---
            function loadItems() {
                try {
                    const storedItems = localStorage.getItem('japanVibeList');
                    const loadedItems = storedItems ? JSON.parse(storedItems) : [];
                    return loadedItems.map(item => ({
                        ...item,
                        thumbBase64: item.thumbBase64 || item.imageBase64 || '',
                        fullBase64: item.fullBase64 || item.imageBase64 || '',
                        timestamp: item.timestamp || item.id,
                        // New fields defaults
                        remark: item.remark || '',
                        actualQuantity: item.actualQuantity !== undefined ? item.actualQuantity : '',
                        actualPrice: item.actualPrice !== undefined ? item.actualPrice : '',
                        imageBase64: undefined 
                    }));
                } catch (e) {
                    console.error("Error loading items:", e);
                    return [];
                }
            }

            function saveItems() {
                try {
                    localStorage.setItem('japanVibeList', JSON.stringify(items));
                    updateFilterOptions(); // Update filters when data changes
                    renderItems();
                    calculateAndDisplayTotals();
                } catch (e) {
                    console.error("Error saving items:", e);
                    showMessage('å„²å­˜è³‡æ–™å¤±æ•—ï¼', 'error');
                }
            }

            // --- CSV Import ---
            function parseCSVLine(text) {
                const result = [];
                let current = '';
                let inQuotes = false;
                for (let i = 0; i < text.length; i++) {
                    const char = text[i];
                    if (char === '"') {
                        if (i + 1 < text.length && text[i + 1] === '"') {
                            current += '"'; i++;
                        } else { inQuotes = !inQuotes; }
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim().replace(/^"|"$/g, '')); current = '';
                    } else { current += char; }
                }
                result.push(current.trim().replace(/^"|"$/g, ''));
                return result;
            }

            function parseCSV(csvText) {
                if (csvText.charCodeAt(0) === 0xFEFF) csvText = csvText.slice(1);
                const lines = csvText.trim().split('\n');
                if (lines.length < 2) { showMessage('CSV æ ¼å¼éŒ¯èª¤', 'error'); return; }

                const headers = parseCSVLine(lines[0]).map(h => h.trim());
                const dataLines = lines.slice(1);
                
                const findIndex = (keywords) => headers.findIndex(h => {
                    const normalizedHeader = h.replace(/\s/g, '').toLowerCase();
                    return keywords.some(k => normalizedHeader.includes(k.replace(/\s/g, '').toLowerCase()));
                });

                const itemNameIndex = findIndex(['è³¼è²·ç‰©', 'é …ç›®åç¨±', 'Item Name', 'é€£çµ', 'Item']);
                const friendNameIndex = findIndex(['å¡«å¯«äºº', 'æœ‹å‹åç¨±', 'Friend Name', 'å§“å', 'Name']);
                const quantityIndex = findIndex(['è³¼è²·é‡', 'æ•¸é‡', 'Quantity']);
                const categoryIndex = findIndex(['é¡å‹', 'Category']); 
                const priceIndex = findIndex(['é è¨ˆé‡‘é¡(JPY)', 'Estimated Price', 'é‡‘é¡']); 
                const linkIndex = findIndex(['åƒè€ƒé€£çµ æˆ– åœ–ç‰‡', 'åƒè€ƒé€£çµ', 'Reference Link', 'é€£çµ', 'URL']); 
                const timestampIndex = findIndex(['æ™‚é–“æˆ³è¨˜', 'Timestamp']);
                
                if (itemNameIndex === -1 || friendNameIndex === -1 || quantityIndex === -1 || categoryIndex === -1 || priceIndex === -1) {
                    showMessage('CSV æ¨™é¡Œè¡Œç„¡æ³•è­˜åˆ¥ã€‚', 'error'); return;
                }

                let newItemsCount = 0;
                let existingItems = new Set(items.map(item => `${item.name}-${item.friend}`));

                dataLines.forEach(line => {
                    const cols = parseCSVLine(line);
                    if (cols.length > Math.max(itemNameIndex, friendNameIndex, quantityIndex)) {
                        const name = cols[itemNameIndex].trim();
                        const friend = cols[friendNameIndex].trim();
                        const quantity = parseInt(cols[quantityIndex].trim());
                        const category = categoryIndex !== -1 ? (cols[categoryIndex].trim() || 'å…¶ä»–') : 'å…¶ä»–';
                        const priceStr = priceIndex !== -1 ? cols[priceIndex].trim().replace(/,/g, '') : '0';
                        const estimatedPrice = parseInt(priceStr) || 0;
                        const referenceLink = linkIndex !== -1 ? cols[linkIndex].trim() : '';
                        const timestampStr = timestampIndex !== -1 ? cols[timestampIndex].trim() : '';
                        const timestamp = Date.parse(timestampStr) || Date.now();
                        
                        const key = `${name}-${friend}`;

                        if (name && friend && !isNaN(quantity) && quantity > 0 && !existingItems.has(key)) {
                            items.push({
                                id: Date.now() + Math.random(), 
                                timestamp: timestamp,
                                name: name,
                                friend: friend,
                                quantity: quantity,
                                category: category, 
                                estimatedPrice: estimatedPrice, 
                                referenceLink: referenceLink, 
                                thumbBase64: '', fullBase64: '', purchased: false,
                                remark: '', actualQuantity: '', actualPrice: '' // New fields
                            });
                            existingItems.add(key);
                            newItemsCount++;
                        }
                    }
                });

                saveItems();
                showMessage(`æˆåŠŸåŒ¯å…¥ ${newItemsCount} å€‹é …ç›®ï¼`, 'success');
                csvFile.value = '';
            }

            // --- Export CSV (New) ---
            function exportCSV() {
                if (items.length === 0) { showMessage('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º', 'error'); return; }

                // Define headers
                const headers = ['æ™‚é–“æˆ³è¨˜', 'å¡«å¯«äºº', 'é¡å‹', 'è³¼è²·ç‰©', 'å‚™è¨»', 'é è¨ˆæ•¸é‡', 'å¯¦éš›è³¼è²·é‡', 'é è¨ˆå–®åƒ¹(JPY)', 'å¯¦éš›å–®åƒ¹(JPY)', 'å°è¨ˆ(JPY)', 'å°è¨ˆ(HKD)', 'ç‹€æ…‹'];
                
                // BOM for UTF-8 in Excel
                let csvContent = "\uFEFF"; 
                csvContent += headers.join(',') + "\n";

                items.forEach(item => {
                    const date = item.timestamp ? new Date(item.timestamp).toLocaleDateString('zh-TW') : '';
                    
                    const estPrice = parseFloat(item.estimatedPrice) || 0;
                    const estQty = parseInt(item.quantity) || 0;
                    
                    const actPrice = (item.actualPrice !== "" && item.actualPrice !== null) ? parseFloat(item.actualPrice) : estPrice;
                    const actQty = (item.actualQuantity !== "" && item.actualQuantity !== null) ? parseInt(item.actualQuantity) : (item.purchased ? estQty : 0);
                    
                    const subtotalJPY = actPrice * actQty;
                    const subtotalHKD = (subtotalJPY * HKD_RATE).toFixed(2);
                    const status = item.purchased ? 'å·²è³¼' : 'æœªè³¼';

                    // Escape quotes and commas
                    const escape = (text) => `"${String(text).replace(/"/g, '""')}"`;

                    const row = [
                        escape(date),
                        escape(item.friend),
                        escape(item.category),
                        escape(item.name),
                        escape(item.remark || ''),
                        escape(estQty),
                        escape(actQty),
                        escape(estPrice),
                        escape(actPrice),
                        escape(subtotalJPY),
                        escape(subtotalHKD),
                        escape(status)
                    ];
                    csvContent += row.join(',') + "\n";
                });

                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `æ—¥æœ¬ä»£è³¼çµç®—å ±å‘Š_${new Date().toLocaleDateString('zh-TW')}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            // --- Event Listeners ---
            csvFile.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => parseCSV(e.target.result);
                reader.readAsText(file, 'UTF-8');
            });

            clearDataBtn.addEventListener('click', async () => {
                if (await showConfirm('ğŸš¨ æ¸…é™¤è­¦å‘Š', 'ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è¨˜éŒ„å—ï¼Ÿ', 'æ°¸ä¹…æ¸…é™¤')) {
                    items = []; saveItems(); showMessage('å·²æ¸…é™¤æ‰€æœ‰è³‡æ–™', 'error');
                }
            });
            
            addItemBtn.addEventListener('click', () => openEditModal(null));
            
            exportBtn.addEventListener('click', exportCSV); // Export Listener

            filterFriend.addEventListener('change', filterItems);
            filterCategory.addEventListener('change', filterItems);

            // --- Rendering ---
            function renderItems() {
                itemList.innerHTML = '';
                
                // Sort
                items.sort((a, b) => {
                    if (a.purchased !== b.purchased) return a.purchased - b.purchased;
                    return b.timestamp - a.timestamp;
                });

                items.forEach((item, index) => {
                    const hasImage = item.thumbBase64 || item.fullBase64;
                    const itemDiv = document.createElement('div');
                    
                    // Display Calculation
                    const estPrice = parseFloat(item.estimatedPrice) || 0;
                    const actPrice = (item.actualPrice !== "" && item.actualPrice !== null) ? parseFloat(item.actualPrice) : estPrice;
                    const finalPrice = item.purchased ? actPrice : estPrice;
                    
                    const estQty = parseInt(item.quantity) || 0;
                    const actQty = (item.actualQuantity !== "" && item.actualQuantity !== null) ? parseInt(item.actualQuantity) : (item.purchased ? estQty : 0);
                    // å¦‚æœå·²è³¼è²·ä½†æ²’å¡«å¯¦éš›æ•¸é‡ï¼Œé¡¯ç¤ºé è¨­æ•¸é‡ï¼Œå¦‚æœæ˜¯æœªè³¼å‰‡é¡¯ç¤ºé è¨ˆ
                    const displayQty = item.purchased && item.actualQuantity !== "" ? actQty : estQty;
                    
                    const itemTotalJPY = finalPrice * displayQty;
                    
                    // Layout
                    const itemLayoutClass = hasImage ? 'grid grid-cols-5 gap-3' : 'flex justify-between items-center';
                    itemDiv.className = `item-card p-4 rounded-xl shadow-lg transition duration-300 card-bg border-l-4 border-gray-600 ${item.purchased ? 'item-purchased success-border' : 'border-accent-bg'} ${itemLayoutClass}`;
                    itemDiv.dataset.index = index;

                    const imageElement = hasImage ? `
                        <div class="col-span-1 ml-auto flex-shrink-0 w-12 h-12 overflow-hidden rounded-md border-2 border-gray-600 cursor-pointer" onclick="openFullImageModal('${item.fullBase64 || item.thumbBase64}', event)">
                            <img src="${item.thumbBase64 || item.fullBase64}" alt="Thumb" class="w-full h-full object-cover">
                        </div>` : '';
                    
                    const date = item.timestamp ? new Date(item.timestamp).toLocaleDateString('zh-TW', { month: 'numeric', day: 'numeric' }) : 'N/A';
                    
                    // Actual info badge
                    const actualBadge = (item.purchased && (item.actualPrice || item.actualQuantity)) 
                        ? `<span class="text-xs bg-green-900/50 text-green-300 px-1 rounded ml-1 border border-green-700">å¯¦</span>` 
                        : '';
                    
                    // Remark block
                    const remarkBlock = item.remark 
                        ? `<div class="mt-1 text-xs text-gray-400 bg-gray-800 p-2 rounded border border-gray-700"><i class="fas fa-sticky-note mr-1 text-gray-500"></i>${item.remark}</div>` 
                        : '';

                    const content = `
                        <div class="${hasImage ? 'col-span-4' : 'flex-grow min-w-0 pr-3'}">
                            <p class="text-lg font-bold item-name whitespace-normal break-words">${item.name} ${actualBadge}</p>
                            ${remarkBlock}
                            
                            <p class="text-sm text-gray-400 mt-2 space-x-2">
                                <span class="text-xs text-gray-500"><i class="fas fa-clock mr-1"></i>${date}</span>
                                <span class="mx-1 text-gray-600">|</span> 
                                <span class="text-base text-gray-300"><i class="fas fa-user-tag mr-1"></i>${item.friend}</span>
                            </p>

                            <p class="text-xs text-gray-400 mt-2 flex items-center flex-wrap">
                                <span class="font-semibold text-gray-300 mr-3"><i class="fas fa-bookmark mr-1"></i>${item.category || 'N/A'}</span>
                                <span class="font-semibold text-accent-text mr-3">
                                    <i class="fas fa-hashtag mr-1"></i>${displayQty} x ${finalPrice.toLocaleString()} = ${itemTotalJPY.toLocaleString()} JPY
                                </span>
                            </p>
                            
                            <p class="text-xs mt-2 flex items-center flex-wrap">
                                ${item.referenceLink ? `<a href="${item.referenceLink}" target="_blank" class="text-blue-400 hover:text-blue-300 mr-3 font-medium"><i class="fas fa-link mr-1"></i>é€£çµ</a>` : ''}
                                ${hasImage ? `<span class="text-green-400 font-medium"><i class="fas fa-image mr-1"></i>åœ–ç‰‡</span>` : ''}
                            </p>
                            ${item.purchased ? '<span class="text-xs font-semibold success-text mt-2 inline-block"><i class="fas fa-check-circle mr-1"></i>å·²è³¼è²·</span>' : ''}
                        </div>
                        ${imageElement}
                        <div class="${hasImage ? 'col-span-5 pt-3 border-t border-gray-700 mt-3 flex justify-end' : 'flex flex-col space-y-2 ml-3 flex-shrink-0'}">
                            <button class="toggle-purchased-btn w-10 h-10 rounded-full flex items-center justify-center transition duration-200 shadow-md ${item.purchased ? 'bg-success-text hover:bg-green-700' : 'accent-bg hover:opacity-80'} ${hasImage ? 'mr-3' : ''}" data-index="${index}">
                                <i class="fas ${item.purchased ? 'fa-undo' : 'fa-shopping-basket'} text-white text-base"></i>
                            </button>
                            <div class="flex space-x-2">
                                <button class="edit-btn w-6 h-6 rounded-full bg-blue-600 text-white flex items-center justify-center hover:bg-blue-700" data-index="${index}"><i class="fas fa-pen text-xs"></i></button>
                                <button class="delete-btn w-6 h-6 rounded-full bg-red-600 text-white flex items-center justify-center hover:bg-red-700" data-index="${index}"><i class="fas fa-trash text-xs"></i></button>
                            </div>
                        </div>
                    `;
                    itemDiv.innerHTML = content;
                    itemList.appendChild(itemDiv);
                });
                
                // Apply filters immediately after render
                filterItems();
            }

            // --- Handlers ---
            itemList.addEventListener('click', (event) => {
                const target = event.target.closest('button');
                if (!target) return;
                const index = parseInt(target.dataset.index);
                if (target.classList.contains('toggle-purchased-btn')) togglePurchased(index);
                else if (target.classList.contains('edit-btn')) openEditModal(index);
                else if (target.classList.contains('delete-btn')) deleteItem(index);
            });

            function togglePurchased(index) {
                items[index].purchased = !items[index].purchased;
                saveItems();
                showMessage(items[index].purchased ? 'å·²æ¨™è¨˜è³¼è²·' : 'æ¨™è¨˜æœªè³¼', 'info');
            }

            async function deleteItem(index) {
                if (await showConfirm('åˆªé™¤ç¢ºèª', `åˆªé™¤ã€Œ${items[index].name}ã€ï¼Ÿ`)) {
                    items.splice(index, 1); saveItems(); showMessage('å·²åˆªé™¤', 'info');
                }
            }

            function openEditModal(index) {
                currentEditIndex = index;
                if (index === null) {
                    modalTitle.textContent = 'æ–°å¢é …ç›®';
                    editForm.reset();
                    imageThumbnail.src = ''; delete imageThumbnail.dataset.thumbBase64; delete imageThumbnail.dataset.fullBase64;
                    imagePreviewContainer.classList.add('hidden'); removeImageBtn.classList.add('hidden');
                    document.getElementById('editQuantity').value = 1;
                } else {
                    modalTitle.textContent = 'ç·¨è¼¯è©³æƒ…';
                    const item = items[index];
                    document.getElementById('editName').value = item.name;
                    document.getElementById('editRemark').value = item.remark || '';
                    document.getElementById('editFriend').value = item.friend;
                    document.getElementById('editQuantity').value = item.quantity;
                    document.getElementById('editEstimatedPrice').value = item.estimatedPrice || '';
                    document.getElementById('editCategory').value = item.category || '';
                    document.getElementById('editReferenceLink').value = item.referenceLink || '';
                    document.getElementById('editPurchased').checked = item.purchased;
                    
                    // New actual fields
                    document.getElementById('editActualQuantity').value = item.actualQuantity !== undefined ? item.actualQuantity : '';
                    document.getElementById('editActualPrice').value = item.actualPrice !== undefined ? item.actualPrice : '';

                    const thumb = item.thumbBase64 || '';
                    if (thumb) {
                        imageThumbnail.src = thumb;
                        imageThumbnail.dataset.thumbBase64 = thumb;
                        imageThumbnail.dataset.fullBase64 = item.fullBase64 || '';
                        imagePreviewContainer.classList.remove('hidden');
                        removeImageBtn.classList.remove('hidden');
                    } else {
                        imageThumbnail.src = '';
                        imagePreviewContainer.classList.add('hidden');
                        removeImageBtn.classList.add('hidden');
                    }
                }
                imageUpload.value = null;
                editModal.classList.remove('hidden');
            }

            closeModalBtn.addEventListener('click', () => { editModal.classList.add('hidden'); currentEditIndex = null; });

            imageUpload.addEventListener('change', async (e) => {
                if (e.target.files[0]) {
                    showMessage('è™•ç†åœ–ç‰‡ä¸­...', 'info');
                    const thumb = await resizeImageAndConvertToBase64(e.target.files[0], THUMB_MAX_SIZE, THUMB_QUALITY);
                    const full = await resizeImageAndConvertToBase64(e.target.files[0], FULL_IMAGE_MAX_SIZE, FULL_IMAGE_QUALITY);
                    imageThumbnail.src = thumb;
                    imageThumbnail.dataset.thumbBase64 = thumb;
                    imageThumbnail.dataset.fullBase64 = full;
                    imagePreviewContainer.classList.remove('hidden'); removeImageBtn.classList.remove('hidden');
                    showMessage('åœ–ç‰‡å·²æº–å‚™', 'success');
                }
            });

            removeImageBtn.addEventListener('click', () => {
                imageThumbnail.src = ''; delete imageThumbnail.dataset.thumbBase64; delete imageThumbnail.dataset.fullBase64;
                imagePreviewContainer.classList.add('hidden'); removeImageBtn.classList.add('hidden');
            });

            editForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const qty = parseInt(document.getElementById('editQuantity').value);
                const estPriceRaw = document.getElementById('editEstimatedPrice').value.replace(/,/g, '');
                const estPrice = parseInt(estPriceRaw) || 0;

                if (isNaN(qty) || qty <= 0) { showMessage('æ•¸é‡éŒ¯èª¤', 'error'); return; }

                const newData = {
                    name: document.getElementById('editName').value.trim(),
                    remark: document.getElementById('editRemark').value.trim(),
                    friend: document.getElementById('editFriend').value.trim(),
                    quantity: qty,
                    estimatedPrice: estPrice,
                    category: document.getElementById('editCategory').value.trim() || 'å…¶ä»–',
                    referenceLink: document.getElementById('editReferenceLink').value.trim(),
                    purchased: document.getElementById('editPurchased').checked,
                    // Actuals
                    actualQuantity: document.getElementById('editActualQuantity').value,
                    actualPrice: document.getElementById('editActualPrice').value,
                    // Images
                    thumbBase64: imageThumbnail.dataset.thumbBase64 || '',
                    fullBase64: imageThumbnail.dataset.fullBase64 || ''
                };

                if (currentEditIndex !== null) {
                    items[currentEditIndex] = { ...items[currentEditIndex], ...newData };
                    delete items[currentEditIndex].imageBase64;
                } else {
                    items.push({ ...newData, id: Date.now() + Math.random(), timestamp: Date.now() });
                }
                
                saveItems();
                editModal.classList.add('hidden');
                currentEditIndex = null;
                showMessage('å·²å„²å­˜', 'success');
            });

            // Initial
            updateFilterOptions();
            renderItems();
            calculateAndDisplayTotals();
        });
    </script>
</body>
</html>
